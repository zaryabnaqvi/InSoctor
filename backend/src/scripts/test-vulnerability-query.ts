import axios from 'axios';
import https from 'https';
import { config } from '../config';

async function testVulnerabilityQuery() {
    console.log('Testing Wazuh Indexer Connection...');
    console.log(`URL: ${config.wazuhIndexer.url}`);
    console.log(`User: ${config.wazuhIndexer.username}`);

    const client = axios.create({
        baseURL: config.wazuhIndexer.url,
        headers: {
            'Content-Type': 'application/json',
        },
        auth: {
            username: config.wazuhIndexer.username || '',
            password: config.wazuhIndexer.password || '',
        },
        httpsAgent: new https.Agent({
            rejectUnauthorized: config.wazuhIndexer.verifySSL,
        }),
    });

    // Test 1: Check indices
    /*
    try {
        console.log('\n--- Test 1: Checking Indices ---');
        const response = await client.get('/_cat/indices/wazuh-states-vulnerabilities-*?v&format=json');
        console.log('Indices found:', response.data);
    } catch (error: any) {
        console.error('Test 1 Failed:', error.message);
    }
    */

    // Test 2: Simple Search
    try {
        console.log('\n--- Test 2: Simple Search (match_all) ---');
        const query = {
            size: 1,
            query: {
                match_all: {}
            }
        };
        const response = await client.post('/wazuh-states-vulnerabilities-*/_search', query);
        console.log('Search successful!');
        console.log('Total hits:', JSON.stringify(response.data.hits.total));
        if (response.data.hits.hits.length > 0) {
            const source = response.data.hits.hits[0]._source;
            console.log('\n=== FULL VULNERABILITY DOCUMENT ===');
            console.log(JSON.stringify(source, null, 2));
        }
    } catch (error: any) {
        console.error('Test 2 Failed:', error.message);
        if (error.response) {
            console.error('Response data:', JSON.stringify(error.response.data, null, 2));
        }
    }

    // Test 3: Aggregation Query (Stats)
    /*
    try {
        console.log('\n--- Test 3: Aggregation Query ---');
        // ...
    } catch (error: any) {
        console.error('Test 3 Failed:', error.message);
    }
    */
}

testVulnerabilityQuery().catch(console.error);
