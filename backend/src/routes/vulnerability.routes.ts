import { Router, Request, Response } from 'express';
import wazuhIndexerService from '@/services/wazuh-indexer.service';
import logger from '@/config/logger';

const router = Router();

/**
 * GET /api/vulnerabilities
 * Get list of vulnerabilities with optional filters
 */
router.get('/', async (req: Request, res: Response) => {
    try {
        const filters = {
            severity: req.query.severity ? (Array.isArray(req.query.severity) ? req.query.severity : [req.query.severity]) : undefined,
            cve: req.query.cve as string,
            package: req.query.package as string,
            agentId: req.query.agentId as string,
            status: req.query.status as string,
            startDate: req.query.startDate as string,
            endDate: req.query.endDate as string,
            limit: req.query.limit ? parseInt(req.query.limit as string) : 100,
            offset: req.query.offset ? parseInt(req.query.offset as string) : 0,
        };

        const result = await wazuhIndexerService.getVulnerabilities(filters);
        res.json(result);
    } catch (error: any) {
        logger.error('Error fetching vulnerabilities', { error: error.message });
        res.status(500).json({ error: 'Failed to fetch vulnerabilities', message: error.message });
    }
});

/**
 * GET /api/vulnerabilities/stats
 * Get vulnerability statistics
 */
router.get('/stats', async (req: Request, res: Response) => {
    try {
        const stats = await wazuhIndexerService.getVulnerabilityStats();
        res.json(stats);
    } catch (error: any) {
        logger.error('Error fetching vulnerability stats', { error: error.message });
        res.status(500).json({ error: 'Failed to fetch vulnerability statistics', message: error.message });
    }
});

/**
 * GET /api/vulnerabilities/trends
 * Get vulnerability trends over time
 */
router.get('/trends', async (req: Request, res: Response) => {
    try {
        const days = req.query.days ? parseInt(req.query.days as string) : 30;
        const trends = await wazuhIndexerService.getVulnerabilityTrends(days);
        res.json(trends);
    } catch (error: any) {
        logger.error('Error fetching vulnerability trends', { error: error.message });
        res.status(500).json({ error: 'Failed to fetch vulnerability trends', message: error.message });
    }
});

/**
 * GET /api/vulnerabilities/packages
 * Get affected packages
 */
router.get('/packages', async (req: Request, res: Response) => {
    try {
        const limit = req.query.limit ? parseInt(req.query.limit as string) : 20;
        const packages = await wazuhIndexerService.getAffectedPackages(limit);
        res.json(packages);
    } catch (error: any) {
        logger.error('Error fetching affected packages', { error: error.message });
        res.status(500).json({ error: 'Failed to fetch affected packages', message: error.message });
    }
});

export default router;
