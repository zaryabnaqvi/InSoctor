import apiClient from './api.service';

export interface VulnerabilityFilters {
    severity?: string[];
    cve?: string;
    package?: string;
    agentId?: string;
    status?: string;
    startDate?: string;
    endDate?: string;
    limit?: number;
    offset?: number;
}

export interface Vulnerability {
    id: string;
    cve: string;
    title: string;
    description: string;
    severity: 'critical' | 'high' | 'medium' | 'low';
    cvssScore: number;
    cvss2?: any;
    cvss3?: any;
    package: {
        name: string;
        version: string;
        architecture: string;
    };
    status: string;
    detectedAt: string;
    publishedAt: string;
    updatedAt: string;
    references: string[];
    agent: {
        id: string;
        name: string;
    };
    condition: string;
    external_references: any[];
}

class VulnerabilityService {
    /**
     * Get vulnerabilities with optional filters
     */
    async getVulnerabilities(filters?: VulnerabilityFilters) {
        const params = new URLSearchParams();

        if (filters) {
            if (filters.severity) {
                filters.severity.forEach(s => params.append('severity', s));
            }
            if (filters.cve) params.append('cve', filters.cve);
            if (filters.package) params.append('package', filters.package);
            if (filters.agentId) params.append('agentId', filters.agentId);
            if (filters.status) params.append('status', filters.status);
            if (filters.startDate) params.append('startDate', filters.startDate);
            if (filters.endDate) params.append('endDate', filters.endDate);
            if (filters.limit) params.append('limit', filters.limit.toString());
            if (filters.offset) params.append('offset', filters.offset.toString());
        }

        const response = await apiClient.get(`/vulnerabilities?${params.toString()}`);
        return response.data;
    }

    /**
     * Get vulnerability statistics
     */
    async getVulnerabilityStats() {
        const response = await apiClient.get('/vulnerabilities/stats');
        return response.data;
    }

    /**
     * Get vulnerability trends
     */
    async getVulnerabilityTrends(days: number = 30) {
        const response = await apiClient.get(`/vulnerabilities/trends?days=${days}`);
        return response.data;
    }

    /**
     * Get affected packages
     */
    async getAffectedPackages(limit: number = 20) {
        const response = await apiClient.get(`/vulnerabilities/packages?limit=${limit}`);
        return response.data;
    }
}

export default new VulnerabilityService();
