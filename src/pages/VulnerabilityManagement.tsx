import { useState, useEffect } from 'react';
import {
    Shield,
    AlertTriangle,
    CheckCircle,
    Search,
    Filter,
    Download,
    RefreshCw,
    Server,
    ExternalLink,
    ChevronLeft,
    ChevronRight,
    AlertOctagon,
    Activity
} from 'lucide-react';
import {
    Card,
    CardContent,
    CardDescription,
    CardHeader,
    CardTitle
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue
} from '@/components/ui/select';
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";
import {
    Tabs,
    TabsContent,
    TabsList,
    TabsTrigger,
} from "@/components/ui/tabs";
import { Skeleton } from '@/components/ui/skeleton';
import {
    PieChart,
    Pie,
    Cell,
    ResponsiveContainer,
    Tooltip as RechartsTooltip,
    Legend,
    BarChart,
    Bar,
    XAxis,
    YAxis,
    CartesianGrid,
    AreaChart,
    Area
} from 'recharts';
import vulnerabilityService, { Vulnerability, VulnerabilityFilters } from '@/services/vulnerability.service';
import { cn } from '@/lib/utils';
import { toast } from 'sonner';

export default function VulnerabilityManagement() {
    const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
    const [stats, setStats] = useState<any>(null);
    const [trends, setTrends] = useState<any[]>([]);
    const [packages, setPackages] = useState<any[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [filters, setFilters] = useState<VulnerabilityFilters>({
        limit: 10,
        offset: 0
    });
    const [searchTerm, setSearchTerm] = useState('');

    const fetchData = async () => {
        setIsLoading(true);
        try {
            const [vulnData, statsData, trendsData, packagesData] = await Promise.all([
                vulnerabilityService.getVulnerabilities({ ...filters, cve: searchTerm || undefined }),
                vulnerabilityService.getVulnerabilityStats(),
                vulnerabilityService.getVulnerabilityTrends(30),
                vulnerabilityService.getAffectedPackages(10)
            ]);

            console.log('=== VULNERABILITY DATA DEBUG ===');
            console.log('Stats Data:', statsData);
            console.log('Stats Total:', statsData?.total);
            console.log('Stats Aggregations:', statsData?.aggregations);
            console.log('Vulnerabilities:', vulnData.vulnerabilities?.length);
            console.log('Trends:', trendsData.trends?.length);
            console.log('Packages:', packagesData.packages?.length);

            setVulnerabilities(vulnData.vulnerabilities);
            setStats(statsData);
            setTrends(trendsData.trends);
            setPackages(packagesData.packages);
        } catch (error) {
            console.error('Failed to fetch vulnerability data:', error);
            toast.error('Failed to load vulnerability data');
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, [filters, searchTerm]);

    const handleRefresh = () => {
        fetchData();
        toast.success('Refreshing vulnerability data...');
    };

    const getSeverityColor = (severity: string) => {
        switch (severity.toLowerCase()) {
            case 'critical': return 'text-red-500 bg-red-500/10 border-red-500/20';
            case 'high': return 'text-orange-500 bg-orange-500/10 border-orange-500/20';
            case 'medium': return 'text-yellow-500 bg-yellow-500/10 border-yellow-500/20';
            case 'low': return 'text-blue-500 bg-blue-500/10 border-blue-500/20';
            default: return 'text-slate-500 bg-slate-500/10 border-slate-500/20';
        }
    };

    const COLORS = {
        critical: '#ef4444',
        high: '#f97316',
        medium: '#eab308',
        low: '#3b82f6'
    };

    const severityData = stats?.aggregations?.by_severity?.buckets?.map((b: any) => ({
        name: b.key.toLowerCase(),
        value: b.doc_count
    })) || [];

    return (
        <div className="space-y-6 p-6 animate-fade-in-up">
            {/* Header */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 className="text-3xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">
                        Vulnerability Management
                    </h1>
                    <p className="text-slate-400 mt-1">
                        Monitor and remediate security vulnerabilities across your infrastructure
                    </p>
                </div>
                <div className="flex items-center gap-2">
                    <Button variant="outline" className="glass-card hover:bg-white/5" onClick={handleRefresh}>
                        <RefreshCw className={cn("mr-2 h-4 w-4", isLoading && "animate-spin")} />
                        Refresh
                    </Button>
                    <Button className="bg-cyan-500 hover:bg-cyan-600 text-black shadow-glow">
                        <Download className="mr-2 h-4 w-4" />
                        Export Report
                    </Button>
                </div>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <Card className="modern-card border-l-4 border-l-cyan-500">
                    <CardContent className="p-6">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-sm font-medium text-slate-400">Total Vulnerabilities</p>
                                <h3 className="text-3xl font-bold mt-2 text-white">{stats?.total || 0}</h3>
                            </div>
                            <div className="p-2 bg-cyan-500/10 rounded-lg">
                                <Shield className="h-6 w-6 text-cyan-500" />
                            </div>
                        </div>
                        <div className="mt-4 flex items-center text-sm text-slate-400">
                            <Activity className="h-4 w-4 mr-1 text-cyan-500" />
                            <span>Active across infrastructure</span>
                        </div>
                    </CardContent>
                </Card>

                <Card className="modern-card border-l-4 border-l-red-500">
                    <CardContent className="p-6">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-sm font-medium text-slate-400">Critical Issues</p>
                                <h3 className="text-3xl font-bold mt-2 text-red-500">
                                    {stats?.aggregations?.by_severity?.buckets?.find((b: any) => b.key.toLowerCase() === 'critical')?.doc_count || 0}
                                </h3>
                            </div>
                            <div className="p-2 bg-red-500/10 rounded-lg">
                                <AlertOctagon className="h-6 w-6 text-red-500" />
                            </div>
                        </div>
                        <div className="mt-4 flex items-center text-sm text-red-400">
                            <AlertTriangle className="h-4 w-4 mr-1" />
                            <span>Requires immediate attention</span>
                        </div>
                    </CardContent>
                </Card>

                <Card className="modern-card border-l-4 border-l-orange-500">
                    <CardContent className="p-6">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-sm font-medium text-slate-400">High Severity</p>
                                <h3 className="text-3xl font-bold mt-2 text-orange-500">
                                    {stats?.aggregations?.by_severity?.buckets?.find((b: any) => b.key.toLowerCase() === 'high')?.doc_count || 0}
                                </h3>
                            </div>
                            <div className="p-2 bg-orange-500/10 rounded-lg">
                                <AlertTriangle className="h-6 w-6 text-orange-500" />
                            </div>
                        </div>
                        <div className="mt-4 flex items-center text-sm text-orange-400">
                            <Activity className="h-4 w-4 mr-1" />
                            <span>Prioritize for patching</span>
                        </div>
                    </CardContent>
                </Card>

                <Card className="modern-card border-l-4 border-l-blue-500">
                    <CardContent className="p-6">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-sm font-medium text-slate-400">Avg CVSS Score</p>
                                <h3 className="text-3xl font-bold mt-2 text-blue-500">
                                    {stats?.aggregations?.avg_cvss?.value?.toFixed(1) || '0.0'}
                                </h3>
                            </div>
                            <div className="p-2 bg-blue-500/10 rounded-lg">
                                <Activity className="h-6 w-6 text-blue-500" />
                            </div>
                        </div>
                        <div className="mt-4 flex items-center text-sm text-slate-400">
                            <CheckCircle className="h-4 w-4 mr-1 text-green-500" />
                            <span>Based on all active vulnerabilities</span>
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Charts Section */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Severity Distribution */}
                <Card className="modern-card lg:col-span-1">
                    <CardHeader>
                        <CardTitle>Severity Distribution</CardTitle>
                        <CardDescription>Breakdown by risk level</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <div className="h-[300px] w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                        data={severityData}
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={60}
                                        outerRadius={80}
                                        paddingAngle={5}
                                        dataKey="value"
                                    >
                                        {severityData.map((entry: any, index: number) => (
                                            <Cell key={`cell-${index}`} fill={COLORS[entry.name as keyof typeof COLORS] || '#8884d8'} />
                                        ))}
                                    </Pie>
                                    <RechartsTooltip
                                        contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: '#f8fafc' }}
                                    />
                                    <Legend />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </CardContent>
                </Card>

                {/* Vulnerability Trends */}
                <Card className="modern-card lg:col-span-2">
                    <CardHeader>
                        <CardTitle>Vulnerability Trends</CardTitle>
                        <CardDescription>Detection history over last 30 days</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <div className="h-[300px] w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={trends}>
                                    <defs>
                                        <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#06b6d4" stopOpacity={0.8} />
                                            <stop offset="95%" stopColor="#06b6d4" stopOpacity={0} />
                                        </linearGradient>
                                    </defs>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                    <XAxis
                                        dataKey="key_as_string"
                                        tickFormatter={(value) => new Date(value).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                        stroke="#94a3b8"
                                    />
                                    <YAxis stroke="#94a3b8" />
                                    <RechartsTooltip
                                        contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: '#f8fafc' }}
                                        labelFormatter={(value) => new Date(value).toLocaleDateString()}
                                    />
                                    <Area
                                        type="monotone"
                                        dataKey="doc_count"
                                        stroke="#06b6d4"
                                        fillOpacity={1}
                                        fill="url(#colorCount)"
                                        name="Vulnerabilities"
                                    />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Main Content Tabs */}
            <Tabs defaultValue="list" className="space-y-4">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <TabsList className="glass-card bg-black/20">
                        <TabsTrigger value="list">Vulnerability List</TabsTrigger>
                        <TabsTrigger value="packages">Affected Packages</TabsTrigger>
                    </TabsList>

                    <div className="flex flex-wrap items-center gap-2">
                        <div className="relative">
                            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400" />
                            <Input
                                placeholder="Search CVE, package..."
                                className="pl-9 w-[200px] sm:w-[300px] bg-black/20 border-white/10 focus:border-cyan-500/50"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <Select
                            value={filters.severity?.[0] || "all"}
                            onValueChange={(val) => setFilters({ ...filters, severity: val === "all" ? undefined : [val] })}
                        >
                            <SelectTrigger className="w-[140px] bg-black/20 border-white/10">
                                <div className="flex items-center gap-2">
                                    <Filter className="h-4 w-4" />
                                    <SelectValue placeholder="Severity" />
                                </div>
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="all">All Severities</SelectItem>
                                <SelectItem value="critical">Critical</SelectItem>
                                <SelectItem value="high">High</SelectItem>
                                <SelectItem value="medium">Medium</SelectItem>
                                <SelectItem value="low">Low</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>
                </div>

                <TabsContent value="list" className="space-y-4">
                    <Card className="modern-card">
                        <CardContent className="p-0">
                            <Table>
                                <TableHeader>
                                    <TableRow className="hover:bg-white/5 border-white/10">
                                        <TableHead className="text-slate-400">CVE ID</TableHead>
                                        <TableHead className="text-slate-400">Title</TableHead>
                                        <TableHead className="text-slate-400">Severity</TableHead>
                                        <TableHead className="text-slate-400">CVSS</TableHead>
                                        <TableHead className="text-slate-400">Package</TableHead>
                                        <TableHead className="text-slate-400">Agent</TableHead>
                                        <TableHead className="text-slate-400">Status</TableHead>
                                        <TableHead className="text-right text-slate-400">Actions</TableHead>
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {isLoading ? (
                                        Array.from({ length: 5 }).map((_, i) => (
                                            <TableRow key={i} className="border-white/10">
                                                <TableCell><Skeleton className="h-4 w-24 bg-slate-800" /></TableCell>
                                                <TableCell><Skeleton className="h-4 w-48 bg-slate-800" /></TableCell>
                                                <TableCell><Skeleton className="h-6 w-20 bg-slate-800 rounded-full" /></TableCell>
                                                <TableCell><Skeleton className="h-4 w-8 bg-slate-800" /></TableCell>
                                                <TableCell><Skeleton className="h-4 w-32 bg-slate-800" /></TableCell>
                                                <TableCell><Skeleton className="h-4 w-24 bg-slate-800" /></TableCell>
                                                <TableCell><Skeleton className="h-4 w-16 bg-slate-800" /></TableCell>
                                                <TableCell><Skeleton className="h-8 w-8 ml-auto bg-slate-800 rounded" /></TableCell>
                                            </TableRow>
                                        ))
                                    ) : vulnerabilities.length === 0 ? (
                                        <TableRow>
                                            <TableCell colSpan={8} className="h-64 text-center text-slate-400">
                                                <div className="flex flex-col items-center justify-center">
                                                    <Shield className="h-12 w-12 text-slate-600 mb-4" />
                                                    <p>No vulnerabilities found matching your criteria</p>
                                                </div>
                                            </TableCell>
                                        </TableRow>
                                    ) : (
                                        vulnerabilities.map((vuln) => (
                                            <TableRow key={vuln.id} className="hover:bg-white/5 border-white/10 group transition-colors">
                                                <TableCell className="font-mono text-cyan-400 font-medium">
                                                    {vuln.cve}
                                                </TableCell>
                                                <TableCell className="max-w-[300px]">
                                                    <div className="truncate" title={vuln.title}>{vuln.title}</div>
                                                </TableCell>
                                                <TableCell>
                                                    <Badge variant="outline" className={cn("capitalize", getSeverityColor(vuln.severity))}>
                                                        {vuln.severity}
                                                    </Badge>
                                                </TableCell>
                                                <TableCell>
                                                    <span className={cn(
                                                        "font-bold",
                                                        vuln.cvssScore >= 9 ? "text-red-500" :
                                                            vuln.cvssScore >= 7 ? "text-orange-500" :
                                                                vuln.cvssScore >= 4 ? "text-yellow-500" : "text-blue-500"
                                                    )}>
                                                        {vuln.cvssScore.toFixed(1)}
                                                    </span>
                                                </TableCell>
                                                <TableCell>
                                                    <div className="flex flex-col">
                                                        <span className="text-sm text-slate-300">{vuln.package.name}</span>
                                                        <span className="text-xs text-slate-500">{vuln.package.version}</span>
                                                    </div>
                                                </TableCell>
                                                <TableCell>
                                                    <div className="flex items-center gap-2">
                                                        <Server className="h-3 w-3 text-slate-500" />
                                                        <span className="text-sm text-slate-300">{vuln.agent.name}</span>
                                                    </div>
                                                </TableCell>
                                                <TableCell>
                                                    <Badge variant="secondary" className="bg-slate-800 text-slate-300">
                                                        {vuln.status}
                                                    </Badge>
                                                </TableCell>
                                                <TableCell className="text-right">
                                                    <Button variant="ghost" size="icon" className="hover:text-cyan-400 hover:bg-cyan-500/10">
                                                        <ExternalLink className="h-4 w-4" />
                                                    </Button>
                                                </TableCell>
                                            </TableRow>
                                        ))
                                    )}
                                </TableBody>
                            </Table>
                        </CardContent>
                        <div className="p-4 border-t border-white/10 flex items-center justify-between">
                            <div className="text-sm text-slate-400">
                                Showing {vulnerabilities.length} results
                            </div>
                            <div className="flex gap-2">
                                <Button
                                    variant="outline"
                                    size="sm"
                                    disabled={filters.offset === 0}
                                    onClick={() => setFilters(f => ({ ...f, offset: Math.max(0, (f.offset || 0) - (f.limit || 10)) }))}
                                    className="glass-card hover:bg-white/5"
                                >
                                    <ChevronLeft className="h-4 w-4" />
                                </Button>
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => setFilters(f => ({ ...f, offset: (f.offset || 0) + (f.limit || 10) }))}
                                    className="glass-card hover:bg-white/5"
                                >
                                    <ChevronRight className="h-4 w-4" />
                                </Button>
                            </div>
                        </div>
                    </Card>
                </TabsContent>

                <TabsContent value="packages">
                    <Card className="modern-card">
                        <CardHeader>
                            <CardTitle>Top Vulnerable Packages</CardTitle>
                            <CardDescription>Software with the most detected vulnerabilities</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="h-[400px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={packages} layout="vertical" margin={{ left: 100 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" horizontal={false} />
                                        <XAxis type="number" stroke="#94a3b8" />
                                        <YAxis
                                            dataKey="key"
                                            type="category"
                                            stroke="#94a3b8"
                                            width={150}
                                            tick={{ fontSize: 12 }}
                                        />
                                        <RechartsTooltip
                                            contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: '#f8fafc' }}
                                            cursor={{ fill: '#334155', opacity: 0.2 }}
                                        />
                                        <Bar dataKey="doc_count" name="Vulnerabilities" fill="#06b6d4" radius={[0, 4, 4, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </CardContent>
                    </Card>
                </TabsContent>
            </Tabs>
        </div>
    );
}
